@using TechZone.Application.DTOs

@using TechZone.Domain.Enums   <!-- HACH LINE ADD KELA (Main fix) -->

@{
    ViewData["Title"] = "My Orders";
}

<div class="container my-5">
    <h2 class="mb-4">
        My Orders
    </h2>

    @if (!Model?.Any() ?? true)
    {
        <div class="text-center py-5">
            <i class="bi bi-bag-x display-1 text-muted"></i>
            <h4 class="mt-4 text-muted">No orders yet</h4>
            <p class="text-muted">When you place an order, it will appear here.</p>
            <a asp-controller="Products" asp-action="Index" class="btn btn-primary mt-3">
                Continue Shopping
            </a>
        </div>
    }
    else
    {
        @foreach (var order in Model)
        {
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <div class="row text-center text-md-start">
                        <div class="col-md-3">
                            <small class="text-muted">Order #</small>
                            <h6 class="mb-0 fw-bold">@order.OrderNumber</h6>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Date</small>
                            <h6 class="mb-0">@order.OrderDate:dd MMM yyyy</h6>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Total</small>
                            <h6 class="mb-0 text-primary">₹@order.TotalAmount:N0</h6>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Status</small>
                            <h6 class="mb-0">
                                <span class="badge bg-@GetStatusColor(order.Status)">
                                    @order.Status
                                </span>
                            </h6>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <h6 class="mb-3">Items (@order.OrderItems.Count)</h6>
                            @foreach (var item in order.OrderItems.Take(3))
                            {
                                <div class="d-flex align-items-center mb-3">
                                    <div class="me-3">
                                        <div class="bg-light rounded p-2">
                                            <i class="bi bi-box-seam text-muted fs-4"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong>@item.ProductName</strong>
                                        <br>
                                        <small class="text-muted">
                                            Qty: @item.Quantity × ₹@item.UnitPrice:N0
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <strong>₹@item.TotalPrice:N0</strong>
                                    </div>
                                </div>
                            }
                            @if (order.OrderItems.Count > 3)
                            {
                                <small class="text-muted">+ @(order.OrderItems.Count - 3) more item(s)</small>
                            }
                        </div>

                        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                            <a asp-action="Details" asp-route-id="@order.Id" class="btn btn-outline-primary btn-sm mb-2">
                                View Details
                            </a>
                            <br />

                            @if (order.Status == OrderStatus.Pending || order.Status == OrderStatus.Confirmed)
                            {
                                <form asp-action="Cancel" asp-route-id="@order.Id" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-outline-danger btn-sm"
                                            onclick="return confirm('Are you sure you want to cancel this order?')">
                                        Cancel Order
                                    </button>
                                </form>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(order.TrackingNumber))
                    {
                        <div class="alert alert-info mt-3 mb-0 d-flex align-items-center">
                            <i class="bi bi-truck me-2"></i>
                            <div>
                                <strong>Tracking Number:</strong> @order.TrackingNumber
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@functions {
    string GetStatusColor(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "warning",
            OrderStatus.Confirmed => "info",
            OrderStatus.Processing => "primary",
            OrderStatus.Shipped => "primary",
            OrderStatus.Delivered => "success",
            OrderStatus.Cancelled => "danger",
            OrderStatus.Refunded => "secondary",
            _ => "secondary"
        };
    }
}